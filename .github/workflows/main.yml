name: Deploy Latest ONNX Model from Snowflake

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - mlops

permissions:
  contents: write

jobs:
  deploy-latest-onnx:
    runs-on: ubuntu-latest

    env:
      SNOWFLAKE_CONNECTIONS_DEFAULT_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Snowflake CLI (v3)
        shell: bash
        run: |
          echo "üêç Installing Snowflake CLI..."
          python3 -m pip install --upgrade pip
          pip install --user --upgrade "snowflake-cli>=3.10.0"
          echo 'export PATH=$HOME/.local/bin:$PATH' >> $GITHUB_ENV
          source $GITHUB_ENV
          snow --version

      - name: Verify Snowflake connection
        shell: bash
        run: |
          echo "üîé Verifying Snowflake connection..."
          snow sql -q "SELECT CURRENT_USER(), CURRENT_ROLE(), CURRENT_DATABASE(), CURRENT_SCHEMA();" --format CSV

      - name: Ensure fallback Snowflake config file if env not detected
        shell: bash
        run: |
          echo "üß© Checking if snow sees default connection..."
          if snow connection list | grep -q "No data"; then
            echo "‚ö†Ô∏è No connections found. Writing ~/.snowflake/config.toml..."
            mkdir -p ~/.snowflake

            # Safe heredoc with single quotes to avoid YAML parsing errors
            cat <<'EOF' > ~/.snowflake/config.toml
[connections.default]
account = "${SNOWFLAKE_CONNECTIONS_DEFAULT_ACCOUNT}"
user = "${SNOWFLAKE_CONNECTIONS_DEFAULT_USER}"
password = "${SNOWFLAKE_CONNECTIONS_DEFAULT_PASSWORD}"
role = "${SNOWFLAKE_CONNECTIONS_DEFAULT_ROLE}"
warehouse = "${SNOWFLAKE_CONNECTIONS_DEFAULT_WAREHOUSE}"
database = "${SNOWFLAKE_CONNECTIONS_DEFAULT_DATABASE}"
schema = "${SNOWFLAKE_CONNECTIONS_DEFAULT_SCHEMA}"
EOF

            echo "‚úÖ Config file created successfully."
          else
            echo "‚úÖ Snowflake connection(s) already available ‚Äî skipping config file."
          fi
          echo "üîé Post-check: snow connection list"
          snow connection list || true

      - name: Find latest ONNX file in Snowflake stage
        id: find_model
        shell: bash
        run: |
          echo "üîç Searching for latest .onnx file in @ML_MODELS_STAGE..."
          LIST_OUT=$(snow sql -q "LIST @ML_MODELS_STAGE;" --format CSV)
          echo "---- Raw LIST output ----"
          echo "$LIST_OUT"
          echo "-------------------------"

          # Sort by last modified timestamp (6th column)
          MODEL_FILE=$(echo "$LIST_OUT" | grep '\.onnx' | sort -t',' -k6,6r | head -n1 | cut -d',' -f1 | tr -d '"')
          if [ -z "$MODEL_FILE" ]; then
            echo "‚ùå No .onnx files found in @ML_MODELS_STAGE."
            exit 1
          fi

          echo "‚úÖ Found latest model: $MODEL_FILE"
          echo "MODEL_FILE=$MODEL_FILE" >> $GITHUB_OUTPUT

      - name: Download latest ONNX model
        shell: bash
        run: |
          MODEL_FILE="${{ steps.find_model.outputs.MODEL_FILE }}"
          echo "üì• Downloading model: ${MODEL_FILE}"
          mkdir -p models
          snow sql -q "GET @ML_MODELS_STAGE/${MODEL_FILE} FILE://models;" --format CSV
          echo "‚úÖ Downloaded files:"
          ls -lh models

      - name: Commit and push latest model
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MODEL_FILE="${{ steps.find_model.outputs.MODEL_FILE }}"
          echo "üíæ Preparing to commit ${MODEL_FILE}..."
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add models/
          git commit -m "Deploy latest ONNX model: ${MODEL_FILE}" || echo "No changes to commit."
          git push || echo "Push failed (protected branch or no changes)."
