name: Deploy Latest ONNX Model from Snowflake

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - mlops

permissions:
  contents: write

jobs:
  deploy-latest-onnx:
    runs-on: ubuntu-latest

    env:
      SNOWFLAKE_CONNECTIONS_DEFAULT_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Snowflake CLI (v3)
        shell: bash
        run: |
          echo "üêç Installing Snowflake CLI..."
          python3 -m pip install --upgrade pip
          pip install --user --upgrade "snowflake-cli>=3.10.0"
          echo 'export PATH=$HOME/.local/bin:$PATH' >> $GITHUB_ENV
          source $GITHUB_ENV
          snow --version

      - name: Configure Snowflake connection
        shell: bash
        run: |
          echo "üß© Creating ~/.snowflake/config.toml..."
          mkdir -p ~/.snowflake
          {
            echo "[connections.default]"
            echo "account = \"${SNOWFLAKE_CONNECTIONS_DEFAULT_ACCOUNT}\""
            echo "user = \"${SNOWFLAKE_CONNECTIONS_DEFAULT_USER}\""
            echo "password = \"${SNOWFLAKE_CONNECTIONS_DEFAULT_PASSWORD}\""
            echo "role = \"${SNOWFLAKE_CONNECTIONS_DEFAULT_ROLE}\""
            echo "warehouse = \"${SNOWFLAKE_CONNECTIONS_DEFAULT_WAREHOUSE}\""
            echo "database = \"${SNOWFLAKE_CONNECTIONS_DEFAULT_DATABASE}\""
            echo "schema = \"${SNOWFLAKE_CONNECTIONS_DEFAULT_SCHEMA}\""
          } > ~/.snowflake/config.toml

          chmod 600 ~/.snowflake/config.toml
          echo "‚úÖ Config file created and secured."
          grep -v "password" ~/.snowflake/config.toml

      - name: Verify Snowflake connection
        shell: bash
        run: |
          echo "üîé Testing Snowflake connection..."
          snow connection list
          snow sql -q "SELECT CURRENT_USER(), CURRENT_ROLE(), CURRENT_DATABASE(), CURRENT_SCHEMA();" --format CSV

      - name: Find latest ONNX file in Snowflake stage
        id: find_model
        shell: bash
        run: |
          echo "üîç Searching for latest .onnx file in @ML_MODELS_STAGE..."
          LIST_OUT=$(snow sql -q "LIST @ML_MODELS_STAGE;" --format CSV)
          echo "---- Raw LIST output ----"
          echo "$LIST_OUT"
          echo "-------------------------"

          # Extract filename and timestamp (5th column), convert to Unix, sort newest first, and pick latest
          MODEL_FILE=$(echo "$LIST_OUT" | grep '\.onnx' | \
            awk -F',' '{gsub(/"/,""); cmd="date -d
