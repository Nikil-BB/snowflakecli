name: Deploy Latest ONNX Model from Snowflake

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - mlops

permissions:
  contents: write

jobs:
  deploy-latest-onnx:
    runs-on: ubuntu-latest

    env:
      SNOWFLAKE_CONNECTIONS_DEFAULT_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Snowflake CLI (v3)
        shell: bash
        run: |
          echo "ðŸ Installing Snowflake CLI..."
          python3 -m pip install --upgrade pip
          pip install --user --upgrade "snowflake-cli>=3.10.0"
          echo 'export PATH=$HOME/.local/bin:$PATH' >> $GITHUB_ENV
          source $GITHUB_ENV
          snow --version

      - name: Configure Snowflake connection
        shell: bash
        run: |
          echo "ðŸ§© Creating ~/.snowflake/config.toml..."
          mkdir -p ~/.snowflake
          {
            echo "[connections.default]"
            echo "account = \"${SNOWFLAKE_CONNECTIONS_DEFAULT_ACCOUNT}\""
            echo "user = \"${SNOWFLAKE_CONNECTIONS_DEFAULT_USER}\""
            echo "password = \"${SNOWFLAKE_CONNECTIONS_DEFAULT_PASSWORD}\""
            echo "role = \"${SNOWFLAKE_CONNECTIONS_DEFAULT_ROLE}\""
            echo "warehouse = \"${SNOWFLAKE_CONNECTIONS_DEFAULT_WAREHOUSE}\""
            echo "database = \"${SNOWFLAKE_CONNECTIONS_DEFAULT_DATABASE}\""
            echo "schema = \"${SNOWFLAKE_CONNECTIONS_DEFAULT_SCHEMA}\""
          } > ~/.snowflake/config.toml

          chmod 600 ~/.snowflake/config.toml
          echo "âœ… Config file created and secured."
          grep -v "password" ~/.snowflake/config.toml

      - name: Verify Snowflake connection
        shell: bash
        run: |
          echo "ðŸ”Ž Testing Snowflake connection..."
          snow connection list
          snow sql -q "SELECT CURRENT_USER(), CURRENT_ROLE(), CURRENT_DATABASE(), CURRENT_SCHEMA();" --format CSV

      - name: Find latest ONNX file in Snowflake stage
        id: find_model
        shell: bash
        run: |
          echo "ðŸ” Searching for latest .onnx file in @ML_MODELS_STAGE..."
          LIST_OUT=$(snow sql -q "LIST @ML_MODELS_STAGE;" --format CSV)
          echo "---- Raw LIST output ----"
          echo "$LIST_OUT"
          echo "-------------------------"

          MODEL_FILE=$(echo "$LIST_OUT" | grep '\.onnx' | sort -t',' -k6,6r | head -n1 | cut -d',' -f1 | tr -d '"')
          if [ -z "$MODEL_FILE" ]; then
            echo "âŒ No .onnx files found in @ML_MODELS_STAGE."
            exit 1
          fi
          echo "âœ… Found latest model: $MODEL_FILE"
          echo "MODEL_FILE=$MODEL_FILE" >> $GITHUB_OUTPUT

      - name: Download latest ONNX model
        shell: bash
        run: |
          MODEL_FILE="${{ steps.find_model.outputs.MODEL_FILE }}"
          echo "ðŸ“¥ Downloading model: ${MODEL_FILE}"
          mkdir -p models
          # Correct CLI syntax for file download
          snow stage copy @ML_MODELS_STAGE/${MODEL_FILE} ./models/
          echo "âœ… Downloaded files:"
          ls -lh models

      - name: Commit and push latest model
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MODEL_FILE="${{ steps.find_model.outputs.MODEL_FILE }}"
          echo "ðŸ’¾ Preparing to commit ${MODEL_FILE}..."
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add models/
          git commit -m "Deploy latest ONNX model: ${MODEL_FILE}" || echo "No changes to commit."
          git push || echo "Push failed (protected branch or no changes)."
