name: Deploy Latest ONNX Model from Snowflake

on:
  push:
    branches: [main, mlops]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy-latest-onnx:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --------------------------
      # Step 1: Install Snowflake CLI manually (stable method)
      # --------------------------
      - name: Install Snowflake CLI manually
        shell: bash
        run: |
          echo "üêç Installing Snowflake CLI..."
          python3 -m pip install --upgrade pip
          pip install --upgrade "snowflake-cli-labs>=2.1.0"
          snow --version

      # --------------------------
      # Step 2: Connect using environment variables and deploy latest model
      # --------------------------
      - name: Fetch and Deploy Latest ONNX Model
        shell: bash
        env:
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}   # e.g. SZBYXJW-ZU11428.snowflakecomputing.com
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
        run: |
          echo "üîó Connecting to Snowflake using environment variables..."

          echo "üîç Finding latest ONNX model..."
          MODEL_FILE=$(snow sql -q "
            LIST @ML_MODELS_STAGE;
          " --format plain | grep '.onnx' | sort -k6,6r | head -n1 | awk '{print $1}' | tr -d '[:space:]')
          echo "‚úÖ Latest model: ${MODEL_FILE}"

          echo "üì• Downloading model ${MODEL_FILE}..."
          mkdir -p models
          snow sql -q "
            USE DATABASE ${SNOWFLAKE_DATABASE};
            USE SCHEMA ${SNOWFLAKE_SCHEMA};
            GET @ML_MODELS_STAGE/${MODEL_FILE} FILE://models;
          " --format plain

          echo "‚úÖ Model files downloaded:"
          ls -lh models

          echo "üíæ Committing model to repository..."
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add models/
          git commit -m "Deploy latest ONNX model: ${MODEL_FILE}" || echo "No new model to commit."
          git push


